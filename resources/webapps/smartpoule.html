<!DOCTYPE html>
<html>
  <title>SmartPoule</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">

  <!--***********************************-->
  <head>
    <icon
        id="blackcard.svg"
        data-url="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjI2MCI+Cgk8ZGVmcz4KCQk8bGluZWFyR3JhZGllbnQgaWQ9ImxnIiBncmFkaWVudFRyYW5zZm9ybT0icm90YXRlKDYwKSI+CgkJCTxzdG9wIHN0b3AtY29sb3I9IiNmZmYiIHN0b3Atb3BhY2l0eT0iLjYiIG9mZnNldD0iMCIgLz4KCQkJPHN0b3Agc3RvcC1jb2xvcj0iI2ZmZiIgc3RvcC1vcGFjaXR5PSIwIiBvZmZzZXQ9IjEiIC8+CgkJPC9saW5lYXJHcmFkaWVudD4KCTwvZGVmcz4KCTxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMjUyIiByeD0iMjUiIHg9IjYiIHk9IjYiIG9wYWNpdHk9IjAuNSIvPgoJPHJlY3Qgd2lkdGg9IjE5MCIgaGVpZ2h0PSIyNTAiIHJ4PSIyNSIgeD0iNSIgeT0iNSIgZmlsbD0iIzAwMDAwMCIvPgoJPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIyNDAiIHJ4PSIyMyIgeD0iMTAiIHk9IjEwIiBmaWxsPSJ1cmwoI2xnKSIgLz4KPC9zdmc+">
    </icon>

    <icon
        id="withdrawal.svg"
        data-url="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPgoKPHN2ZwogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHZlcnNpb249IjEuMCIKICAgd2lkdGg9IjE5MiIKICAgaGVpZ2h0PSIxOTIiCiAgIGlkPSJTdGFyIG9mIGxpZmUiPgogIDxkZWZzCiAgICAgaWQ9ImRlZnMyODg2IiAvPgogIDxnCiAgICAgaWQ9ImNyb3NzIj4KICAgIDxwYXRoCiAgICAgICBkPSJtIDc0LDEzMyAwLDUyIDQ0LDAgMCwtNTIgNDQsMjYgMjIsLTM4IEwgMTQwLDk2IDE4NCw3MCAxNjIsMzIgMTE3LDU4IDExNyw3IDc0LDcgNzQsNTggMzAsMzIgOCw3MCA1Miw5NiA4LDEyMSAzMCwxNTkgeiIKICAgICAgIGlkPSJvdXRsaW5lIgogICAgICAgc3R5bGU9ImZpbGw6bm9uZTtzdHJva2U6IzMzMzNiYjtzdHJva2Utd2lkdGg6NiIgLz4KICAgIDxwYXRoCiAgICAgICBkPSJtIDc0LDEzMyAwLDUyIDQ0LDAgMCwtNTIgNDQsMjYgMjIsLTM4IEwgMTQwLDk2IDE4NCw3MCAxNjIsMzIgMTE3LDU4IDExNyw3IDc0LDcgNzQsNTggMzAsMzIgOCw3MCA1Miw5NiA4LDEyMSAzMCwxNTkgeiIKICAgICAgIGlkPSJpbm5lciIKICAgICAgIHN0eWxlPSJmaWxsOiMwMDAwYmI7ZmlsbC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlOiNmZmZmZmY7c3Ryb2tlLXdpZHRoOjIiIC8+CiAgPC9nPgogIDxnCiAgICAgaWQ9InN5bWJvbHMiCiAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6IzMzMzNiYjtzdHJva2Utd2lkdGg6MiI+CiAgICA8cGF0aAogICAgICAgZD0ibSA5MywxNjYgYyAwLDcgNiw3IDYsMCBsIDMsLTEzOCBjIDAsLTggLTEyLC04IC0xMiwwIGwgMywxMzUgMCwzIHoiCiAgICAgICBpZD0icm9kIiAvPgogICAgPGcKICAgICAgIGlkPSJzbmFrZSI+CiAgICAgIDxwYXRoCiAgICAgICAgIGQ9Im0gMTAwLDE1MyBjIDcsNCAzLDE1IC0zLDE1IDIsLTUgMywtOSAzLC0xNSB6IG0gMSwtNDAgYyAxMCw5IDQsMjIgLTMsMjYgLTYsMyAtNiw3IC02LDE1IC05LC0xMCAtNCwtMTkgNCwtMjQgNSwtNCA1LC0xMCA1LC0xNyB6IG0gMSwtMzAgYyAwLDExIC0xNywxNCAtMTcsMjIgMCwzIDEsOSA2LDEyIDAsLTExIDksLTEyIDE1LC0xOCA3LC03IDcsLTE5IC00LC0yOCAwLDQgMCw4IDAsMTIgeiBNIDkwLDc3IEMgODAsNjkgNzYsNTUgODAsNDYgYyAzLC0xMCAyMCwtMTEgMjAsLTMgMCw4IC0yMCwzIC0xMywxNiBsIDMsNSAwLDEzIHoiCiAgICAgICAgIGlkPSJib2R5IiAvPgogICAgICA8cGF0aAogICAgICAgICBkPSJtIDk1LDQzIGMgNywtMyAtNywtMyAwLDAgeiIKICAgICAgICAgaWQ9ImV5ZSIKICAgICAgICAgc3R5bGU9ImZpbGw6IzMzMzNiYjtmaWxsLXJ1bGU6ZXZlbm9kZDtzdHJva2U6bm9uZSIgLz4KICAgIDwvZz4KICA8L2c+Cjwvc3ZnPgo=">
    </icon>

    <style>
      * {
        box-sizing: border-box;
      }

      .aspect-ratio {
        width:      100vw;
        max-width:  59.00vh;  /* height:width ratio */
        max-height: 100vh;
        height:     168.00vw; /* height:width ratio */
        margin:     auto;
        position:   absolute;
        top:0;  bottom:0;     /* vertical center */
        left:0; right:0;      /* horizontal center */
      }

      body {
        font-family: Arial, Helvetica, sans-serif;
        background-color: grey;
        -webkit-touch-callout: none; /* iOS Safari */
        -webkit-user-select: none;   /* Chrome 6.0+, Safari 3.1+, Edge & Opera 15+ */
        -moz-user-select: none;      /* Firefox */
        -ms-user-select: none;       /* IE 10+ and Edge */
        user-select: none;           /* Non-prefixed version,
                                        currently supported by Chrome and Opera */
      }

      /* Scorekeeper */
      .row {
        height:1%;
      }

      .score {
        font-size: 10vh;
        text-align: center;
      }

      .spacer {
        font-size: 1vh;
        text-align: center;
      }

      .competition {
        font-size: 3vh;
        text-align: center;
      }

      .fencer-name, .fault, .point {
        font-size: 4vh;
        text-align: center;
      }

      .fencer-name {
        width: 50vw;
        overflow: hidden;
        text-overflow: ".";
      }

      .fencer-firstname {
        font-size: 2vh;
        text-align: center;
      }

      .fault {
        margin: 1vh 0vh 2vh 0vh;
      }

      td img {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      /* Match list */
      td.td_matchlist {
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      table.table_matchlist {
        border-collapse: collapse;
        width: 100%;
      }

      th.th_matchlist, td.td_matchlist {
        text-align: left;
      }

      td.td_piste {
        text-align: right;
      }

      tr.tr_matchlist {
        font-size: 5vw;
      }

      tr.tr_matchlist:nth-child(even) {
        background-color: Lightgreen;
      }
    </style>
  </head>

  <!--***********************************-->
  <script>
    var red_fencer;
    var green_fencer;
    var scorekeeper;
    var matchlist;
    var socket      = new WebSocket ("ws://" + document.domain + ':' + location.port, "smartpoule");

    !function(e,t){"use strict";var n=null,a="ontouchstart"in e||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,i=a?"touchstart":"mousedown",o=a?"touchend":"mouseup",m=a?"touchmove":"mousemove",u=0,r=0,s=10,c=10;function l(i){v(i);var m=i.target,u=parseInt(m.getAttribute("data-long-press-delay")||"1500",10);n=function(t,n){if(!(e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame&&e.mozCancelRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame))return e.setTimeout(t,n);var a=(new Date).getTime(),i={},o=function(){(new Date).getTime()-a>=n?t.call():i.value=requestAnimFrame(o)};return i.value=requestAnimFrame(o),i}(function(e){v();var n=a?e.touches[0].clientX:e.clientX,i=a?e.touches[0].clientY:e.clientY;this.dispatchEvent(new CustomEvent("long-press",{bubbles:!0,cancelable:!0,detail:{clientX:n,clientY:i}}))&&t.addEventListener(o,function e(n){t.removeEventListener(o,e,!0),function(e){e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation()}(n)},!0)}.bind(m,i),u)}function v(t){var a;(a=n)&&(e.cancelAnimationFrame?e.cancelAnimationFrame(a.value):e.webkitCancelAnimationFrame?e.webkitCancelAnimationFrame(a.value):e.webkitCancelRequestAnimationFrame?e.webkitCancelRequestAnimationFrame(a.value):e.mozCancelRequestAnimationFrame?e.mozCancelRequestAnimationFrame(a.value):e.oCancelRequestAnimationFrame?e.oCancelRequestAnimationFrame(a.value):e.msCancelRequestAnimationFrame?e.msCancelRequestAnimationFrame(a.value):clearTimeout(a)),n=null}"function"!=typeof e.CustomEvent&&(e.CustomEvent=function(e,n){n=n||{bubbles:!1,cancelable:!1,detail:void 0};var a=t.createEvent("CustomEvent");return a.initCustomEvent(e,n.bubbles,n.cancelable,n.detail),a},e.CustomEvent.prototype=e.Event.prototype),e.requestAnimFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,1e3/60)},t.addEventListener(o,v,!0),t.addEventListener(m,function(e){var t=Math.abs(u-e.clientX),n=Math.abs(r-e.clientY);(t>=s||n>=c)&&v()},!0),t.addEventListener("wheel",v,!0),t.addEventListener("scroll",v,!0),t.addEventListener(i,function(e){u=e.clientX,r=e.clientY,l(e)},!0)}(window,document);

    function getMessageField (message,
                              field)
    {
      let pattern = new RegExp (field + '=.*\\n');

      if (pattern.test (message))
      {
        return message.match (pattern)[0];
      }
      return '';
    }

    // -- Score --------------------
    class Score {
      constructor (display)
      {
        this.status = '';

        this.display = display;
        this.reset ();
      }

      setListener (listener)
      {
        this.listener = listener;
      }

      increment (delta)
      {
        this.points += delta;
        this.refresh ();
      }

      setPoints (points)
      {
        if (points != null)
        {
          this.points = Number (points);
          this.refresh ();
        }
      }

      setStatus (status)
      {
        if (status != null)
        {
          this.status = status;
          this.refresh ();
        }
      }

      reset ()
      {
        this.points = 0
        this.refresh ();
      }

      refresh ()
      {
        let row_size = this.display.children[0].getBoundingClientRect().height;

        if (this.status == 'A')
        {
          let svg = document.getElementById ('withdrawal.svg');

          this.display.children[0].innerHTML = '<img src="data:image/svg+xml;base64,' + svg.dataset.url + '" width="' + row_size + '"/>';
        }
        else if (this.status == 'E')
        {
          let svg = document.getElementById ('blackcard.svg');

          this.display.children[0].innerHTML = '<img src="data:image/svg+xml;base64,' + svg.dataset.url + '" width="' + row_size*.7 + '"/>';
        }
        else if (this.status == 'V')
        {
          this.display.children[0].innerHTML = this.status + this.points
        }
        else
        {
          this.display.children[0].innerHTML = this.points
        }

        if (this.listener)
        {
          this.listener.onNewScore ();
        }
      }
    }


    // -- Sensor --------------------
    class Sensor {
      constructor ()
      {
        this.freezed = false;
      }

      setTrigger (trigger)
      {
        this.trigger = trigger;
        if (this.trigger != null)
        {
          let context = this;

          this.trigger.onclick = function () {Sensor.onClicked (context);};
          this.trigger.addEventListener ('long-press', function (e) {Sensor.onLongPress (context, e);});
        }
      }

      freeze ()
      {
        if (typeof window.orientation == 'undefined')
        {
          this.freezed = true;
        }
      }

      unFreeze ()
      {
        this.freezed = false;
      }

      static onClicked (what)
      {
        if (what.freezed == false)
        {
          what.onSensorClicked (what);
        }
        what.unFreeze ();
      }

      static onLongPress (what, e)
      {
        e.preventDefault ();
        what.freeze ();
        what.onSensorLongPress (what);
      }
    }


    // -- Counter --------------------
    class Counter extends Sensor {
      constructor (trigger,
                   countable,
                   step)
      {
        super ();

        this.countable = countable;
        this.step      = step;
        this.hits      = 0;

        this.setTrigger (trigger);
      }

      reset ()
      {
        this.hits = 0;
      }

      reStart ()
      {
        this.hits = 0;
        this.countable.reset ();
      }

      count ()
      {
        if (this.step >= 0)
        {
          this.hits++;
          this.countable.increment (this.step);
          return true;
        }
        return false;
      }

      onSensorClicked (sensor)
      {
        this.count ();
      }

      onSensorLongPress (sensor)
      {
        this.cancel ();
      }

      cancel ()
      {
        if (this.hits > 0)
        {
          this.hits--;
          this.countable.increment (-this.step);
        }
      }
    };


    // -- Light --------------------
    class Light extends Counter {
      constructor (trigger, countable, step)
      {
        super (trigger, countable, step);

        this.listeners = [];
      }

      cancel ()
      {
        this.countable.reset ();

        this.listeners.forEach (listener => listener.reset ());
      }

      addListener (counter)
      {
        this.listeners.push (counter);
      }
    };


    // -- Card --------------------
    class Card extends Sensor {
      constructor (listener,
                   cell,
                   html,
                   code)
      {
        super ();

        this.code     = code;
        this.listener = listener;

        cell.innerHTML = html
        cell.colSpan   = 2;
        this.setTrigger (cell);
      }

      reset ()
      {
        this.listener.onCardCancelled (this.code);
      }

      onSensorClicked (sensor)
      {
        this.listener.onCardClicked (this.code);
      }

      onSensorLongPress (sensor)
      {
        this.reset ();
      }
    };


    // -- FaultCounter --------------------
    class FaultCounter extends Counter {
      constructor (trigger,
                   penalties)
      {
        super (trigger, new Score (trigger), 1);

        this.penalties = penalties;
      }

      setCountable (countable)
      {
        this.counter1 = new Counter (null, countable, this.penalties[0]);
        this.counter2 = new Counter (null, countable, this.penalties[1]);
      }

      reset ()
      {
        this.counter2.reset ();
        this.counter1.reset ();

        this.reStart ();
      }

      count ()
      {
        let counter;

        if (this.counter1.hits > 0)
        {
          counter = this.counter2;
        }
        else
        {
          counter = this.counter1;
        }

        if (counter.count ())
        {
          super.count ();
        }
      }

      cancel ()
      {
        if (this.counter2.hits > 0)
        {
         this.counter2.cancel ();
        }
        else
        {
         this.counter1.cancel ();
        }

        super.cancel ();
      }
    };


    // -- Competition --------------------
    class Competition {
      constructor (xml)
      {
        this.xml     = xml;
        this.fencers = this.xml.getElementsByTagName ('Tireurs')[0];
      }

      get (attribute)
      {
        return this.xml.getAttribute (attribute);
      }

      getFencer (id)
      {
        for (let f = 0; f < this.fencers.childElementCount; f++)
        {
          let current = this.fencers.children[f];

          if (current.getAttribute ('ID') == id)
          {
            return current;
          }
        }
      }

      addPanel ()
      {
        let weapon  = {'S':'Sabre', 'E':'Epée', 'F':'Fleuret', 'X':'Educ', 'L':'Laser'};
        let gender  = {'M':'Homme', 'F':'Dame', 'X':'Mixte'};
        let lastRow = document.getElementById ('competition.panel');
        let cell    = lastRow.insertCell (-1);
        let html    = '';

        html += '</td>';
        html += '<td>';
        html += '  <div class="spacer">';
        html += '&nbsp';
        html += '  </div>';
        html += '  <div class="competition">';
        html +=     weapon[this.get ('Arme')] + ' '
        html +=     gender[this.get ('Sexe')] + ' ';
        html +=     this.get ('Categorie');
        html += '  </div>';
        html += '</td>';
        cell.innerHTML = html;

        cell.colSpan = 12;
        cell.style.background = this.get ('Couleur');
      }
    }


    // -- Batch --------------------
    class Batch {
      constructor (xml)
      {
        let context = this;
        let parser  = new DOMParser ();
        let xml_doc = parser.parseFromString (xml, 'text/xml');
        let root    = xml_doc.getElementsByTagName ('CompetitionIndividuelle')[0];
        let scheme  = '/CompetitionIndividuelle/RondeSuisse';

        this.competition = new Competition (root);

        {
          let nodes = xml_doc.evaluate (scheme, root, null, XPathResult.ANY_TYPE, null);
          let node  = nodes.iterateNext ();

          if (node)
          {
            let table = document.getElementById ('matchlist');

            this.stage = parseInt (node.getAttribute ('NetID'), 16);

            for (let i = 0; i < node.childElementCount; i++)
            {
              let match    = node.childNodes[i];
              let match_id = match.getAttribute ('ID');
              let row      = table.insertRow (-1);

              row.setAttribute ('class', 'tr_matchlist');
              row.addEventListener ('click', function () {Batch.onClicked (context, match_id);});

              for (let f = 0; f < node.childNodes[i].childElementCount; f++)
              {
                let fencer_node = node.childNodes[i].childNodes[f];
                let fencer_id   = fencer_node.getAttribute ('REF');
                let fencer      = this.competition.getFencer (fencer_id);
                let cell        = row.insertCell (-1);
                let html        = '<td">' + fencer.getAttribute ('Nom') + '</td>';

                cell.setAttribute ('class', 'td_matchlist');
                cell.innerHTML = html;
              }

              {
                let cell = row.insertCell (-1);
                let html = '<td><b>Piste ' + match.getAttribute ('Piste') + '</b></td>';

                cell.setAttribute ('class', 'td_piste');
                cell.innerHTML = html;
              }
            }
          }
        }
      }

      static onClicked (batch, match) {
        let msg = '';

        msg += '[Header]\n';
        msg += 'name=SmartPoule::ScoreSheetCall\n';
        msg += 'netid=0\n';
        msg += 'fitness=1\n';
        msg += '[Body]\n'
        msg += 'competition=' + batch.competition.get ('ID') + '\n';
        msg += 'stage=' + batch.stage + '\n';
        msg += 'batch=1\n';
        msg += 'bout=' + match + '\n';

        socket.send (msg);
      }
    }

    // -- ScoreSheet --------------------
    class ScoreSheet {
      constructor (msg,
                   red_fencer,
                   green_fencer)
      {
        let xml;

        {
          let tag    = 'xml=';
          let offset = msg.data.indexOf (tag);

          xml = msg.data.slice (offset + tag.length);
          xml = xml.replace (/\\n/g, '');
        }

        this.competition = getMessageField (msg.data, 'competition');
        this.stage       = getMessageField (msg.data, 'stage');
        this.batch       = getMessageField (msg.data, 'batch');

        {
          let parser      = new DOMParser ();
          let xml_doc     = parser.parseFromString (xml, 'text/xml');
          let root        = xml_doc.getElementsByTagName ('CompetitionIndividuelle')[0];
          let competition = new Competition (root);
          let schemes     = ['PhaseDeTableaux/SuiteDeTableaux/Tableau/Match', 'RondeSuisse/Match'];

          competition.addPanel ();

          for (let scheme of schemes)
          {
            let path  = '/CompetitionIndividuelle/' + scheme;
            let nodes = xml_doc.evaluate (path, root, null, XPathResult.ANY_TYPE, null);
            let node  = nodes.iterateNext ();

            if (node && node.childElementCount == 2)
            {
              this.bout    = 'bout=' + node.getAttribute ('ID') + '\n';
              this.fencers = [red_fencer, green_fencer];

              for (let f = 0; f < 2; f++)
              {
                this.fencers[f].display ();

                this.fencers[f].feed (competition, node.childNodes[f]);
                this.fencers[f].score.setListener (this);
              }
            }
          }
        }

        red_fencer.setOpponent   (green_fencer);
        green_fencer.setOpponent (red_fencer);
      }

      onNewScore ()
      {
        let dropped_match = false;
        let msg = '';

        msg += '[Header]\n';
        msg += 'name=SmartPoule::Score\n';
        msg += 'netid=0\n';
        msg += 'fitness=1\n';
        msg += '[Body]\n'
        msg += this.competition;
        msg += this.stage;
        msg += this.batch;
        msg += this.bout;
        msg += 'xml=<?xml version="1.0" encoding="UTF-8"?>'
        msg += '<Match>'

        for (let f = 0; f < 2; f++)
        {
          if (   (this.fencers[f].score.status == 'A')
              || (this.fencers[f].score.status == 'E'))
          {
            dropped_match = true;
            break;
          }
        }

        for (let f = 0; f < 2; f++)
        {
          msg += '<Tireur REF="' + this.fencers[f].ref + '"';
          if (dropped_match == false)
          {
            msg += ' Score="' + this.fencers[f].score.points + '"';
          }
          if (this.fencers[f].score.status != '')
          {
            msg += ' Statut="' + this.fencers[f].score.status + '"';
          }
          msg += '/>';
        }
        msg += '</Match>';

        socket.send (msg);
      }
    }


    // -- Fencer --------------------
    class Fencer {
      constructor (color)
      {
        this.rgb           = {'red':'#8F1818', 'green':'#098709'};
        this.color         = color;
        this.freezed       = false;
        this.taintedPanels = [];
        this.faults        = [{'color':'white',  'penalties':[0, 3]},
                              {'color':'orange', 'penalties':[3, 5]},
                              {'color':'red',    'penalties':[5, -1]}];
      }

      setOpponent (opponent)
      {
        this.opponent = opponent;

        for (let i = 0; i < this.faults.length; i++)
        {
          this.faults[i].counter.setCountable (opponent.score);
          this.light.addListener (opponent.faults[i].counter);
        }

        this.light.addListener (this.withdrawal_card);
        this.light.addListener (this.excluded_card);
      }

      onCardClicked (code)
      {
        if (this.score.status == code)
        {
          this.onCardCancelled ();
        }
        else if (code == 'V')
        {
          if (this.score.points >= this.opponent.score.points)
          {
            this.score.setStatus          ('V');
            this.opponent.score.setStatus ('D');
          }
        }
        else
        {
          this.score.setStatus (code);
        }
      }

      onCardCancelled (code)
      {
        this.score.setStatus ('');
      }

      display ()
      {
        this.addIdentityPanel ('name');
        this.addIdentityPanel ('firstname');
        this.addLightPanel    (this.color);
        this.addPointsPanel   ();
        this.addCardsPanel    ();
        this.addFaultsPanel   ();
      }

      feed (competition, node)
      {
        let name      = document.getElementById (this.color + '-fencer-name');
        let firstname = document.getElementById (this.color + '-fencer-firstname');

        this.taintedPanels.forEach (panel => panel.style.background = competition.get ('Couleur'));

        this.ref = node.getAttribute ('REF');
        name.innerHTML      = competition.getFencer (this.ref).getAttribute('Nom');
        firstname.innerHTML = competition.getFencer (this.ref).getAttribute('Prenom');

        this.score.setPoints (node.getAttribute ('Score'));
        this.score.setStatus (node.getAttribute ('Statut'));
      }

      addIdentityPanel (what)
      {
        let lastRow = document.getElementById (what + 's.panel');
        let cell    = lastRow.insertCell (-1);
        let html    = '';

        html += '<td>';
        html += '  <div id="' + this.color + '-fencer-' + what + '" class="fencer-' + what + '">';
        html +=     what;
        html += '  </div>';
        html += '</td>';
        cell.innerHTML = html;

        cell.colSpan = 6;

        this.taintedPanels.push (cell);
      }

      addLightPanel (color)
      {
        let lastRow = document.getElementById ('lights.panel');
        let cell    = lastRow.insertCell (-1);
        let html    = '';

        html += '<td>';
        html += '  <div class="score">0</div>';
        html += '</td>';
        cell.innerHTML = html;

        cell.colSpan = 6;
        cell.style.backgroundColor = this.rgb[color]

        this.score = new Score (cell);
        this.light = new Light (cell, this.score, 1);
      }

      addPointsPanel ()
      {
        let lastRow = document.getElementById ('points.panel');

        this.pointTriggers = []
        for (let p = 1; p < 4; p++)
        {
          let cell = lastRow.insertCell (-1);
          let html = '';

          html += '<td>';
          html += '  <div class="point">';
          html +=     p;
          html += '  </div>';
          html += '</td>';
          cell.innerHTML = html;

          cell.colSpan = 2;

          this.pointTriggers[p] = new Counter (cell, this.score, p);
          this.light.addListener (this.pointTriggers[p]);
        }
      }

      addCardsPanel ()
      {
        let svg             = document.getElementById ('withdrawal.svg');
        let lastRow         = document.getElementById ('cards.panel');
        let withdrawal_cell = lastRow.insertCell (-1);
        let victory_cell    = lastRow.insertCell (-1);
        let excluded_cell   = lastRow.insertCell (-1);
        let context         = this;
        let row_size;

        this.victory_card = new Card (this,
                                      victory_cell,
                                      '<td><div class="point">V</div></td>',
                                      'V');
        row_size = victory_cell.getBoundingClientRect().height;

        this.withdrawal_card = new Card (this,
                                         withdrawal_cell,
                                         '<td><img src="data:image/svg+xml;base64,' + svg.dataset.url + '" width="' + row_size*1.0 + '"/></td>',
                                         'A');

        svg = document.getElementById ('blackcard.svg');
        this.excluded_card = new Card (this,
                                       excluded_cell,
                                       '<td><img src="data:image/svg+xml;base64,' + svg.dataset.url + '" width="' + row_size*.7 + '"/></td>',
                                       'E');
      }

      addFaultsPanel ()
      {
        for (let fault of this.faults)
        {
          let lastRow = document.getElementById ('faults-' + fault.color + '.panel');
          let html    = '';
          let cell;

          lastRow.insertCell (-1);
          lastRow.insertCell (-1);
          cell = lastRow.insertCell (-1);

          html += '<td>';
          html += '  <div class="fault" style="background:' + fault.color + ';"></div>';
          html += '</td>';
          cell.innerHTML = html;

          cell.style.backgroundColor = 'grey';

          lastRow.insertCell (-1);
          lastRow.insertCell (-1);
          lastRow.insertCell (-1);

          fault.counter = new FaultCounter (cell,
                                            fault.penalties);
        }
      }
    }


    // -- Socket -------------------
    socket.onopen = function ()
    {
      red_fencer   = new Fencer ('red');
      green_fencer = new Fencer ('green');

      scorekeeper = document.getElementById ('scorekeeper');
      matchlist   = document.getElementById ('matchlist');

      {
        let msg = '';

        msg += '[Header]\n';
        msg += 'name=SmartPoule::JobListCall\n';
        msg += 'netid=0\n';
        msg += 'fitness=1\n';

        socket.send (msg);
      }
    }

    socket.onclose = function ()
    {
    }

    socket.onmessage = function (msg)
    {
      if (msg.data.startsWith ('[Header]\nname=BellePoule::ScoreSheet'))
      {
        matchlist.style.display   = 'none';
        scorekeeper.style.display = 'table';

        score_sheet = new ScoreSheet (msg,
                                      red_fencer,
                                      green_fencer);
      }
      else if (msg.data.startsWith ('[Header]\nname=BellePoule::JobList'))
      {
        tag    = 'xml=';
        offset = msg.data.indexOf (tag);;
        xml    = msg.data.slice (offset + tag.length);
        xml    = xml.replace (/\\n/g, '');
        batch  = new Batch (xml);

        scorekeeper.style.display = 'none';
        matchlist.style.display   = 'table';
      }
    }
  </script>

  <!--***********************************-->
  <body>
      <table id='matchlist' class='table_matchlist'>

      <table id='scorekeeper' class='aspect-ratio' style='display:none' Cellspacing='0'>
        <tr class='row' id='competition.panel'/>
        <tr class='row' id='names.panel'/>
        <tr class='row' id='firstnames.panel'/>
        <tr class='row' id='lights.panel'/>
        <tr class='row' id='points.panel'/>
        <tr class='row' id='cards.panel'/>
        <tr class='row' id='faults-white.panel'/>
        <tr class='row' id='faults-orange.panel'/>
        <tr class='row' id='faults-red.panel'/>
        <tr>
          <td Colspan='12'/>
        </tr>
      </table>
    </table>
  </body>
</html>
